# encoding: utf-8
require 'spec_helper'
require_relative '../../../lib/notifiers/buildpack-cve-email-preparer'
require 'tmpdir'

describe BuildpackCVEEmailPreparer do
  describe '#build_message' do
    let(:email_preparer_dir) { Dir.mktmpdir }
    let(:header) { File.join(email_preparer_dir, 'header') }
    let(:subject) { File.join(email_preparer_dir, 'subject') }
    let(:body) { File.join(email_preparer_dir, 'body') }

    before do
      ENV['EMAIL_PREPARER_DIR'] = email_preparer_dir
    end

    after do
      ENV['EMAIL_PREPARER_DIR'] = nil
    end

    it "should prepare email" do
      test_cves = [{title: "CVE-2014-8080: Denial of Service XML Expansion",
                    description:"Unrestricted entity expansion",
                    raw_description: "<p>Unrestricted entity expansion</p>" },
                   {title: "CVE-2015-1855: Ruby OpenSSL Hostname Verification",
                    description: "Ruby OpenSSL error",
                    raw_description:"<p> Ruby OpenSSL error</p>"}]

      BuildpackCVEEmailPreparer.build_message(test_cves)
      expect(File.read(header)).to eq(<<~HEADER)
        MIME-version: 1.0
        Content-Type: text/html; charset="UTF-8"
      HEADER
      expected_subjects = test_cves.map{|value| value[:title]}.join(",")
      expected_bodies = test_cves.map{|value| value[:raw_description]}.join("\n")
      expect(File.read(subject)).to eq(expected_subjects)
      expect(File.read(body)).to eq(expected_bodies)
    end
  end

end
